<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skoda Settings</title>
  <script
    type="text/javascript"
    src="/homey.js"
    data-origin="settings"
  ></script>
  <style>
    .token-display {
      background-color: #f5f5f5;
      padding: 12px;
      border-radius: 4px;
      margin: 12px 0;
      font-family: monospace;
      font-size: 12px;
      word-break: break-all;
      max-height: 100px;
      overflow-y: auto;
    }
    .token-display.empty {
      color: #999;
      font-style: italic;
    }
    .test-button {
      margin-top: 8px;
    }
    .status-message {
      margin-top: 8px;
      padding: 8px;
      border-radius: 4px;
      display: none;
    }
    .status-message.success {
      background-color: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #4caf50;
    }
    .status-message.error {
      background-color: #ffebee;
      color: #c62828;
      border: 1px solid #f44336;
    }
    .status-message.info {
      background-color: #e3f2fd;
      color: #1565c0;
      border: 1px solid #2196f3;
    }
  </style>
</head>
<body>
  <div class="homey-header">
    <h2 class="homey-subtitle">Configure your Skoda Connect credentials</h2>
  </div>
  
  <form class="homey-form">
    <div class="homey-form-group">
      <label class="homey-form-label" for="refresh_token">Refresh Token</label>
      <input 
        type="text" 
        id="refresh_token" 
        name="refresh_token" 
        class="homey-form-input" 
        placeholder="Enter your Skoda Connect refresh token"
      />
      <p class="homey-form-help">Enter your Skoda Connect refresh token to authenticate with the API.</p>
      
      <button type="button" class="homey-button-secondary homey-button-small test-button" id="test-token">Test Token</button>
      <div id="test-status" class="status-message"></div>
    </div>
    
    <div class="homey-form-group">
      <label class="homey-form-label">Current Access Token</label>
      <div id="access_token_display" class="token-display empty">Not loaded yet. Click "Test Token" to refresh.</div>
      <p class="homey-form-help">This is the current access token obtained from your refresh token. It will be automatically refreshed when needed.</p>
    </div>
    
    <button class="homey-button-primary homey-button-full" type="submit">Save</button>
  </form>

  <script>
    function onHomeyReady(Homey) {
      const refreshTokenInput = document.getElementById('refresh_token');
      const testButton = document.getElementById('test-token');
      const testStatus = document.getElementById('test-status');
      const accessTokenDisplay = document.getElementById('access_token_display');

      // Load current settings and access token
      Homey.get('refresh_token', function(err, value) {
        if (!err && value) {
          refreshTokenInput.value = value;
        }
        // Load last access token if available
        // Try multiple times with delay to catch async storage
        setTimeout(loadAccessToken, 500);
        setTimeout(loadAccessToken, 1500);
        setTimeout(loadAccessToken, 3000);
      });

      function loadAccessToken() {
        Homey.get('_last_access_token', function(err, token) {
          if (err) {
            console.error('Error loading access token:', err);
          }
          
          if (!err && token && typeof token === 'string' && token.length > 0) {
            const displayToken = token.length > 40 
              ? token.substring(0, 20) + '...' + token.substring(token.length - 20)
              : token;
            accessTokenDisplay.textContent = displayToken;
            accessTokenDisplay.className = 'token-display';
            accessTokenDisplay.title = 'Full token: ' + token;
            console.log('Access token loaded:', displayToken);
          } else {
            // Check for error
            Homey.get('_token_error', function(err2, errorMsg) {
              if (!err2 && errorMsg && errorMsg.length > 0) {
                accessTokenDisplay.textContent = 'Error: ' + errorMsg;
                accessTokenDisplay.className = 'token-display empty';
              } else {
                accessTokenDisplay.textContent = 'Not tested yet. Click "Test Token" to refresh.';
                accessTokenDisplay.className = 'token-display empty';
              }
            });
          }
        });
      }

      // Test token function
      function testToken() {
        const refreshToken = refreshTokenInput.value.trim();
        
        if (!refreshToken) {
          showStatus('Please enter a refresh token first.', 'error');
          accessTokenDisplay.textContent = 'No refresh token provided';
          accessTokenDisplay.className = 'token-display empty';
          return;
        }

        testButton.disabled = true;
        testButton.textContent = 'Testing...';
        testStatus.style.display = 'none';
        accessTokenDisplay.textContent = 'Testing token...';
        accessTokenDisplay.className = 'token-display';

        // Save token first
        Homey.set('refresh_token', refreshToken, function(saveErr) {
          if (saveErr) {
            testButton.disabled = false;
            testButton.textContent = 'Test Token';
            showStatus('Failed to save token: ' + saveErr.message, 'error');
            accessTokenDisplay.textContent = 'Save failed';
            accessTokenDisplay.className = 'token-display empty';
            return;
          }

          // Trigger explicit token test by setting a flag
          Homey.set('_test_token_flag', true, function(flagErr) {
            if (flagErr) {
              console.error('Failed to set test flag:', flagErr);
            }

            // Wait a moment for the token refresh to complete, then reload the access token
            // Poll for the access token with retries
            let retries = 0;
            const maxRetries = 15; // Increased retries since we're explicitly testing
            const checkInterval = setInterval(function() {
              retries++;
              Homey.get('_last_access_token', function(err, token) {
                if (!err && token && token.length > 0) {
                  clearInterval(checkInterval);
                  const displayToken = token.length > 40 
                    ? token.substring(0, 20) + '...' + token.substring(token.length - 20)
                    : token;
                  accessTokenDisplay.textContent = displayToken;
                  accessTokenDisplay.className = 'token-display';
                  accessTokenDisplay.title = 'Full token: ' + token;
                  
                  // Check for errors
                  Homey.get('_token_error', function(err2, errorMsg) {
                    if (!err2 && errorMsg && errorMsg.length > 0) {
                      showStatus('Token test failed: ' + errorMsg, 'error');
                      accessTokenDisplay.textContent = 'Error: ' + errorMsg;
                      accessTokenDisplay.className = 'token-display empty';
                    } else {
                      showStatus('Token test successful! Access token obtained.', 'success');
                    }
                    testButton.disabled = false;
                    testButton.textContent = 'Test Token';
                  });
                } else if (retries >= maxRetries) {
                  clearInterval(checkInterval);
                  // Check for errors
                  Homey.get('_token_error', function(err2, errorMsg) {
                    if (!err2 && errorMsg && errorMsg.length > 0) {
                      showStatus('Token test failed: ' + errorMsg, 'error');
                      accessTokenDisplay.textContent = 'Error: ' + errorMsg;
                      accessTokenDisplay.className = 'token-display empty';
                    } else {
                      showStatus('Token test timed out. Please try again.', 'info');
                      accessTokenDisplay.textContent = 'Test timed out. Please try again.';
                      accessTokenDisplay.className = 'token-display empty';
                    }
                    testButton.disabled = false;
                    testButton.textContent = 'Test Token';
                  });
                }
              });
            }, 500);
          });
        });
      }

      function showStatus(message, type) {
        testStatus.textContent = message;
        testStatus.className = 'status-message ' + type;
        testStatus.style.display = 'block';
      }

      // Test button click handler
      testButton.addEventListener('click', function(event) {
        event.preventDefault();
        testToken();
      });

      // Handle form submission
      document.querySelector('.homey-form').addEventListener('submit', function(event) {
        event.preventDefault();
        const refreshToken = refreshTokenInput.value.trim();
        
        if (!refreshToken) {
          Homey.alert('Please enter a refresh token.', 'error');
          return;
        }

        Homey.set('refresh_token', refreshToken, function(err) {
          if (err) {
            Homey.alert('Failed to save settings: ' + err.message, 'error');
            return;
          }
          Homey.alert('Settings saved successfully.', 'success');
          // Auto-test after saving (by setting the test flag)
          Homey.set('_test_token_flag', true, function(flagErr) {
            if (flagErr) {
              console.error('Failed to trigger token test:', flagErr);
            }
          });
        });
      });

      // Hide loading indicator
      Homey.ready();
    }
  </script>
</body>
</html>

